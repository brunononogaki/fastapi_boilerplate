
name: run_tests
on: 
  push:
    branches:
      - main
  pull_request:
    branches:
      - main  
  workflow_call:
    secrets:
      DATABASE_HOST:
        required: true
      DATABASE_PORT:
        required: true
      POSTGRES_USER:
        required: true
      POSTGRES_PASSWORD:
        required: true
      POSTGRES_DB:
        required: true
      ADMIN_PASSWORD:
        required: true
      SECRET_KEY:
        required: true
      ALGORITHM:
        required: true
      ACCESS_TOKEN_EXPIRE_MINUTES:
        required: true

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      DATABASE_HOST: ${{ secrets.DATABASE_HOST }}
      DATABASE_PORT: ${{ secrets.DATABASE_PORT }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      ALGORITHM: ${{ secrets.ALGORITHM }}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}

    steps:
      - name: "Download code"
        uses: actions/checkout@v4

      - name: "Install Python 3.13"
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'    

      - name: "Install Poetry"
        run: pipx install poetry

      - name: "Install dependencies"
        run: poetry install

      - name: "Run tests"
        run: poetry run task test
